openapi: 3.0.3
info:
  title: DocVault Document Archiving System API
  description: |
    REST API for the DocVault Document Archiving System - a comprehensive solution for document storage,
    OCR processing, and intelligent search capabilities.

    ## Features
    - Secure document upload and storage
    - OCR text extraction
    - Full-text search with Meilisearch
    - Role-based access control (RBAC)
    - Document categorization and tagging
    - Audit logging

    ## Authentication
    All API endpoints (except /api/auth/*) require JWT authentication.
    Include the token in the Authorization header: `Authorization: Bearer {token}`
  version: 1.0.0
  contact:
    name: DocVault API Support
    email: support@docvault.local
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080/api
    description: Local development server
  - url: https://docvault.example.com/api
    description: Production server

tags:
  - name: Authentication
    description: User authentication and authorization
  - name: Documents
    description: Document management operations
  - name: Search
    description: Document search functionality
  - name: Users
    description: User management (admin only)
  - name: Categories
    description: Category management
  - name: Tags
    description: Tag management
  - name: Roles
    description: Role and permission management
  - name: Profile
    description: User profile management
  - name: Webhooks
    description: Webhook endpoints for external service integrations (OCR service callbacks)

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
        code:
          type: string
          description: Error code
        details:
          type: object
          description: Additional error details

    ValidationError:
      type: object
      required:
        - error
        - violations
      properties:
        error:
          type: string
          example: Validation failed
        violations:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string

    Document:
      type: object
      properties:
        id:
          type: string
          format: uuid
        filename:
          type: string
        originalName:
          type: string
        mimeType:
          type: string
        fileSize:
          type: integer
          format: int64
        filePath:
          type: string
        ocrText:
          type: string
          nullable: true
        metadata:
          type: object
          nullable: true
        processingStatus:
          type: string
          enum: [uploaded, queued, processing, completed, failed]
          description: Current processing status of the document
        progress:
          type: integer
          minimum: 0
          maximum: 100
          nullable: true
          description: Processing progress percentage (0-100). Only present during processing.
          example: 75
        currentOperation:
          type: string
          nullable: true
          description: Description of current processing operation. Only present during processing.
          example: "Performing OCR on page 5/10"
        thumbnailPath:
          type: string
          nullable: true
        categoryId:
          type: string
          format: uuid
          nullable: true
        tags:
          type: array
          items:
            type: string
        uploadedBy:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
          nullable: true

    DocumentList:
      type: object
      properties:
        documents:
          type: array
          items:
            $ref: '#/components/schemas/Document'
        total:
          type: integer
        page:
          type: integer
        limit:
          type: integer

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        firstName:
          type: string
        lastName:
          type: string
        roles:
          type: array
          items:
            type: string
        isActive:
          type: boolean
        isVerified:
          type: boolean
        createdAt:
          type: string
          format: date-time

    Category:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        parentId:
          type: string
          format: uuid
          nullable: true
        level:
          type: integer
        createdAt:
          type: string
          format: date-time

    Tag:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        color:
          type: string
          nullable: true
        usageCount:
          type: integer
        createdAt:
          type: string
          format: date-time

    WebhookOcrCompleted:
      type: object
      description: Webhook payload for successfully completed OCR processing
      required:
        - task_id
        - document_id
        - status
        - result
        - timestamp
      properties:
        task_id:
          type: string
          description: OCR task identifier
          example: "task-abc123"
        document_id:
          type: string
          description: Document identifier
          example: "doc-xyz789"
        status:
          type: string
          enum: [completed]
          description: Processing status
        result:
          type: object
          required:
            - text
          properties:
            text:
              type: string
              description: Extracted OCR text
              example: "Invoice FV/2024/001\\nAcme Corporation"
            confidence_score:
              type: string
              description: OCR confidence score (0-1 range)
              example: "0.95"
            language:
              type: string
              description: Detected language code
              example: "eng"
            page_count:
              type: integer
              description: Number of pages processed
              example: 1
            processing_time:
              type: number
              format: float
              description: Processing time in seconds
              example: 2.5
            metadata:
              type: object
              description: Extracted structured metadata
              properties:
                invoice_numbers:
                  type: array
                  items:
                    type: string
                  example: ["FV/2024/001"]
                names:
                  type: array
                  items:
                    type: string
                  example: ["Acme Corporation"]
                dates:
                  type: array
                  items:
                    type: string
                  example: ["2024-01-15"]
                amounts:
                  type: array
                  items:
                    type: number
                  example: [5000.00]
                tax_ids:
                  type: array
                  items:
                    type: string
                  example: ["123-456-78-90"]
                emails:
                  type: array
                  items:
                    type: string
                  example: ["contact@acme.com"]
            category:
              type: object
              description: Document classification
              properties:
                primary_category:
                  type: string
                  example: "invoice"
                confidence:
                  type: number
                  format: float
                  example: 0.92
        timestamp:
          type: integer
          format: int64
          description: Unix timestamp of webhook generation
          example: 1705334400

    WebhookOcrFailed:
      type: object
      description: Webhook payload for failed OCR processing
      required:
        - task_id
        - document_id
        - status
        - error
        - timestamp
      properties:
        task_id:
          type: string
          description: OCR task identifier
          example: "task-def456"
        document_id:
          type: string
          description: Document identifier
          example: "doc-failed123"
        status:
          type: string
          enum: [failed]
          description: Processing status
        error:
          type: string
          description: Error message describing why processing failed
          example: "File is corrupted or unreadable"
        timestamp:
          type: integer
          format: int64
          description: Unix timestamp of webhook generation
          example: 1705334400

paths:
  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register a new user
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - firstName
                - lastName
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                firstName:
                  type: string
                lastName:
                  type: string
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  token:
                    type: string
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /documents:
    get:
      tags:
        - Documents
      summary: List all documents
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: category
          in: query
          schema:
            type: string
            format: uuid
        - name: tags
          in: query
          schema:
            type: array
            items:
              type: string
        - name: sort
          in: query
          schema:
            type: string
            enum: [createdAt, updatedAt, filename, fileSize]
            default: createdAt
        - name: order
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: List of documents
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentList'

    post:
      tags:
        - Documents
      summary: Create a new document (metadata only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - filename
                - mimeType
                - fileSize
              properties:
                filename:
                  type: string
                mimeType:
                  type: string
                fileSize:
                  type: integer
                metadata:
                  type: object
      responses:
        '201':
          description: Document created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'

  /documents/{id}:
    get:
      tags:
        - Documents
      summary: Get document by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Document details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Documents
      summary: Update document
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                filename:
                  type: string
                metadata:
                  type: object
                categoryId:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Document updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'

    delete:
      tags:
        - Documents
      summary: Delete document
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Document deleted
        '404':
          description: Document not found

  /documents/{id}/processing-status:
    get:
      tags:
        - Documents
      summary: Get document processing status (Task 5.13)
      description: |
        Returns the current processing status of a document, including real-time progress updates.

        **Progress Tracking:**
        - `progress`: 0-100 percentage of completion
        - `current_operation`: Descriptive message of current operation

        **Status Flow:**
        - `uploaded` (0%) → `queued` (0%) → `processing` (1-99%) → `completed` (100%)
        - Can also transition to `failed` at any stage
      parameters:
        - name: id
          in: path
          description: Document ID
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Processing status retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  document_id:
                    type: string
                    format: uuid
                    example: "550e8400-e29b-41d4-a716-446655440000"
                  status:
                    type: string
                    enum: [uploaded, queued, processing, completed, failed]
                    example: "processing"
                  progress:
                    type: integer
                    minimum: 0
                    maximum: 100
                    nullable: true
                    description: Progress percentage (0-100). Present during processing.
                    example: 50
                  current_operation:
                    type: string
                    nullable: true
                    description: Current operation description. Present during processing.
                    example: "Performing OCR on page 5/10"
                  error:
                    type: string
                    nullable: true
                    description: Error message if status is failed
                    example: null
                  task_id:
                    type: string
                    nullable: true
                    description: OCR task ID for tracking
                    example: "task-abc123"
                  ocr_text:
                    type: string
                    nullable: true
                    description: Extracted text (only when completed)
                  confidence_score:
                    type: string
                    nullable: true
                    description: OCR confidence score 0-1
                    example: "0.95"
                  category:
                    type: string
                    nullable: true
                    description: Auto-detected category
                    example: "Invoice"
                  extracted_date:
                    type: string
                    format: date
                    nullable: true
                    description: Extracted date from document
                    example: "2024-01-15"
                  extracted_amount:
                    type: string
                    nullable: true
                    description: Extracted amount from document
                    example: "1500.00"
              examples:
                uploading:
                  summary: Document just uploaded
                  value:
                    document_id: "550e8400-e29b-41d4-a716-446655440000"
                    status: "uploaded"
                    progress: 0
                    current_operation: null
                    error: null
                    task_id: null
                    ocr_text: null
                    confidence_score: null
                    category: null
                    extracted_date: null
                    extracted_amount: null
                queued:
                  summary: Document queued for processing
                  value:
                    document_id: "550e8400-e29b-41d4-a716-446655440000"
                    status: "queued"
                    progress: 0
                    current_operation: "Waiting in queue"
                    error: null
                    task_id: "task-abc123"
                    ocr_text: null
                    confidence_score: null
                    category: null
                    extracted_date: null
                    extracted_amount: null
                processing_25:
                  summary: Processing at 25% (document conversion)
                  value:
                    document_id: "550e8400-e29b-41d4-a716-446655440000"
                    status: "processing"
                    progress: 25
                    current_operation: "Performing OCR on 10 pages"
                    error: null
                    task_id: "task-abc123"
                    ocr_text: null
                    confidence_score: null
                    category: null
                    extracted_date: null
                    extracted_amount: null
                processing_50:
                  summary: Processing at 50% (mid-OCR)
                  value:
                    document_id: "550e8400-e29b-41d4-a716-446655440000"
                    status: "processing"
                    progress: 50
                    current_operation: "Performing OCR on page 5/10"
                    error: null
                    task_id: "task-abc123"
                    ocr_text: null
                    confidence_score: null
                    category: null
                    extracted_date: null
                    extracted_amount: null
                processing_75:
                  summary: Processing at 75% (metadata extraction)
                  value:
                    document_id: "550e8400-e29b-41d4-a716-446655440000"
                    status: "processing"
                    progress: 75
                    current_operation: "Extracting metadata"
                    error: null
                    task_id: "task-abc123"
                    ocr_text: null
                    confidence_score: null
                    category: null
                    extracted_date: null
                    extracted_amount: null
                completed:
                  summary: Processing completed successfully
                  value:
                    document_id: "550e8400-e29b-41d4-a716-446655440000"
                    status: "completed"
                    progress: 100
                    current_operation: null
                    error: null
                    task_id: "task-abc123"
                    ocr_text: "Invoice\nDate: 2024-01-15\nAmount: $1,500.00..."
                    confidence_score: "0.95"
                    category: "Invoice"
                    extracted_date: "2024-01-15"
                    extracted_amount: "1500.00"
                failed:
                  summary: Processing failed
                  value:
                    document_id: "550e8400-e29b-41d4-a716-446655440000"
                    status: "failed"
                    progress: 50
                    current_operation: null
                    error: "OCR service timeout after 300 seconds"
                    task_id: "task-abc123"
                    ocr_text: null
                    confidence_score: null
                    category: null
                    extracted_date: null
                    extracted_amount: null
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /documents/upload:
    post:
      tags:
        - Documents
      summary: Upload a document
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                title:
                  type: string
                description:
                  type: string
      responses:
        '201':
          description: Document uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  document:
                    $ref: '#/components/schemas/Document'
                  message:
                    type: string

  /documents/batch-upload:
    post:
      tags:
        - Documents
      summary: Upload multiple documents
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - files
              properties:
                files:
                  type: array
                  items:
                    type: string
                    format: binary
                metadata:
                  type: string
                  description: JSON string of metadata per file
      responses:
        '200':
          description: Batch upload completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  successCount:
                    type: integer
                  failureCount:
                    type: integer
                  success:
                    type: array
                    items:
                      type: object
                  failed:
                    type: array
                    items:
                      type: object

  /search:
    get:
      tags:
        - Search
      summary: Search documents
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Search query
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: category
          in: query
          schema:
            type: string
            format: uuid
        - name: tags
          in: query
          schema:
            type: array
            items:
              type: string
        - name: dateFrom
          in: query
          schema:
            type: string
            format: date
        - name: dateTo
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/Document'
                  total:
                    type: integer
                  query:
                    type: string

  /categories:
    get:
      tags:
        - Categories
      summary: List all categories
      responses:
        '200':
          description: List of categories
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'

    post:
      tags:
        - Categories
      summary: Create a new category
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                description:
                  type: string
                parentId:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Category created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'

  /tags:
    get:
      tags:
        - Tags
      summary: List all tags
      responses:
        '200':
          description: List of tags
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Tag'

    post:
      tags:
        - Tags
      summary: Create a new tag
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                color:
                  type: string
      responses:
        '201':
          description: Tag created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'

  /profile:
    get:
      tags:
        - Profile
      summary: Get current user profile
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

    put:
      tags:
        - Profile
      summary: Update current user profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                firstName:
                  type: string
                lastName:
                  type: string
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /webhooks/ocr/callback:
    post:
      tags:
        - Webhooks
      summary: OCR processing webhook callback
      description: |
        Webhook endpoint for OCR service to notify backend when document processing completes.

        This endpoint is called by the OCR service (not by API clients) and uses HMAC-SHA256
        signature verification instead of JWT authentication.

        **Security:** Requests must include `X-Webhook-Signature` header with HMAC-SHA256 signature.

        **Idempotency:** This endpoint is idempotent and can receive the same callback multiple times.

        **Flow:**
        1. OCR service completes processing (success or failure)
        2. OCR service generates HMAC signature of payload
        3. OCR service sends POST request to this endpoint
        4. Backend validates signature
        5. Backend updates document status and stores OCR results
        6. Backend dispatches async message to index document in search
      security: []  # No JWT required - uses HMAC signature instead
      parameters:
        - in: header
          name: X-Webhook-Signature
          required: true
          schema:
            type: string
          description: HMAC-SHA256 signature of the request body using shared webhook secret
          example: "a1b2c3d4e5f6789..."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/WebhookOcrCompleted'
                - $ref: '#/components/schemas/WebhookOcrFailed'
              discriminator:
                propertyName: status
                mapping:
                  completed: '#/components/schemas/WebhookOcrCompleted'
                  failed: '#/components/schemas/WebhookOcrFailed'
            examples:
              completed:
                summary: Successful OCR processing
                value:
                  task_id: "task-abc123"
                  document_id: "doc-xyz789"
                  status: "completed"
                  result:
                    text: "Invoice FV/2024/001\\nAcme Corporation\\nDate: 2024-01-15\\nAmount: 5000.00 PLN"
                    confidence_score: "0.95"
                    language: "eng"
                    page_count: 1
                    processing_time: 2.5
                    metadata:
                      invoice_numbers: ["FV/2024/001"]
                      names: ["Acme Corporation"]
                      dates: ["2024-01-15"]
                      amounts: [5000.00]
                      tax_ids: ["123-456-78-90"]
                    category:
                      primary_category: "invoice"
                      confidence: 0.92
                  timestamp: 1705334400
              failed:
                summary: Failed OCR processing
                value:
                  task_id: "task-def456"
                  document_id: "doc-failed123"
                  status: "failed"
                  error: "File is corrupted or unreadable"
                  timestamp: 1705334400
      responses:
        '200':
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Webhook processed successfully"
                  document_id:
                    type: string
                    example: "doc-xyz789"
                  status:
                    type: string
                    enum: [completed, failed]
                    example: "completed"
        '400':
          description: Bad request (invalid JSON, missing fields, unknown status)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_json:
                  summary: Malformed JSON payload
                  value:
                    error: "Invalid JSON payload: Syntax error"
                missing_field:
                  summary: Missing required field
                  value:
                    error: "Missing required field: document_id"
                unknown_status:
                  summary: Unknown status value
                  value:
                    error: "Unknown status: processing"
        '401':
          description: Unauthorized (missing or invalid signature)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missing_signature:
                  summary: Missing signature header
                  value:
                    error: "Missing webhook signature"
                invalid_signature:
                  summary: Invalid HMAC signature
                  value:
                    error: "Invalid webhook signature"
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Document not found"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Internal server error processing webhook"
